## NOTES
## Meguca OP vs normal posts has the header/image order swapped.
##   This shoves the header to the right, instead of above the image
##   I've mimicked it here, though I feel like it could be resolved in css
## All if_exists else None checks are done in the macros themselves
##   This is just to keep the main macro itself cleaner, because jinja2
##   is fucking unreadable as it is
## JINJA2 LINE MODE is turned on, using # for statements, and ## for comments.

{% macro _header(boardname, threadid, post, isop=false )%} 
    {% set tid = threadid %}
    {% set pid = post.id %}
    <header>
        <input type="checkbox" class="postCheckbox">
        <span class="control">â–¶</span>
        {% if isop %} <!-- subject is for threads only, at least for now -->
        <h3> {{ post.subject }} </h3>
        {% endif %}
        <b class="name"> {{ post.name }} </b>
        <time title="{{post.timestamp}}"> {{post.h_time}}</time>
        <nav>
            <a href="/{{boardname}}/{{tid}}#{{pid}}" class="history">No.</a> <!-- tid == pid for threads -->
            <a href="/{{boardname}}/{{tid}}#{{pid}}" class="quote">{{pid}}</a>
        </nav>
        {% if isop %}
        <span class="act expansionLinks">
            <a href="/{{boardname}}/{{tid}}" class="history">Expand</a>
            ## I don't think I care to actually implement this
            ## <a href="/{{boardname}}/{{tid}}?last=100" class="history">Last 100</a>
        </span>
        {% endif %}
    </header>
{%- endmacro %}

{% macro _replies(boardname, replylist ) %}
    <small>
        {% for r in replylist %}
            {% set rid = r.tail %}
            {% set tid = r.thread_id %}
            <a href="/{{boardname}}/{{tid}}#{{rid}}" class="history"> >>{{rid}} </a>
        {% endfor %}
    </small>
{%- endmacro %}

{% macro _figure(filelist, isop) %}
    ## based on meguca sizing
    # if isop:                      
        {% set width = cfg.op_thumb_max_width %}
        {% set height= cfg.op_thumb_max_height %}
    # else:
        {% set width = cfg.post_thumb_max_width %}
        {% set height= cfg.post_thumb_max_height %}
    # endif 

    # for f in filelist:
        {% set tf = '' %}
        # if f.spoilered:
            {% set tf = 'spoilered.jpg' %}
        # else:
            {% set tf = f.filename + '.jpg' %} 
        # endif
        
        # if f.filetype == 'webm':
            {% set class = 'video' %}
        # elif f.filetype == 'pdf':
            {% set class = 'pdf' %}
        # else:
            {% set class = 'image' %}
        # endif

        {% set thumbf = "src/thumb/" + tf %} ## this should be changed to cfg.option
        {% set mainf = "src/imgs/" + f.filename + '.' + f.filetype %} ## this should be changed to cfg.option
        {% set linkt = url_for('static', filename= thumbf) %}
        {% set linkf = url_for('static', filename= mainf) %}
        <figure 
            <figcaption>
            <!-- imgsearch urls -->
            </figcaption> 
            <a target="_blank" rel="nofollow" id="{{f.filename}}" class="{{class}}" href="{{ linkf }}">
                ## pdfs will also have an image thumbnail but won't inline expand (due to class='pdf')
                <img src="{{linkt}}" class="thumb" style="max-width:{{width}}; max-height:{{height}}">
            </a>
        </figure>
    # endfor
{%- endmacro %}


{% macro article(boardname, threadid, post, isop, counts='') %}
    {% set tid = threadid %}
    {% set pid = post.id %} 
    # if isop:
        {{ _figure(post.files, isop=true) }}  ## meguca op max h/w is 250x250
        {{ _header(boardname, threadid, post, isop=true )}}
    # else:
        {{ _header(boardname, threadid, post, isop=false )}}
        {{ _figure(post.files, isop=false ) }} ## meguca op max h/w is 125x125
    # endif
    <blockquote>
        {{ post.parsed | safe}}
    </blockquote>
    {{ _replies(boardname, post.tails ) }}
    # if counts:
        <span class="omit"> {{counts[0]}} replies and {{counts[1]}} images omitted </span>
    # endif
{%- endmacro %}
